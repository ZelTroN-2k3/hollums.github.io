<!DOCTYPE html>
<html>
	<head>
		<title>Pac-Man: The Gloves Are Off!</title>
		<style type="text/css">
			canvas {border-width:3px;border-style:solid;border-color:yellow;background:black;margin:0 auto;display:block}
			h1 {border-width:3px;border-style:solid;border-color:yellow;background:black;display:block;text-align:center}
			body {background-color:#282828  }
			.wrapper{text-align:center;padding:5px;}
		</style>
		
		<script type="text/javascript">
		
		// piercing rounds
		// chain rounds
		var menEn = new Array();
		
		var ctx;
		var pink_ghost;
		var orange_ghost;
		var red_ghost;
		var blue_ghost;
		var green_ghost;
		var flee_ghost;
		var player_img;
		var thisTime=0;
		
		var menuX;
		var menuY;
		
		var test = 0;
		
		var inMenu = true;
		var thisTime = -1;
		
		var interval = 10; //milliseconds
		var thisInterval;
		var ms = 0;	
		var time = ms/10;
		var chaseBeginTime=0;
		var chaseCountDown=0;
	
		var INITIALBULLETRADIUS=5;
		var MAXBULLETRADIUS=10;
		var CURRENTBULLETRADIUS=INITIALBULLETRADIUS;
		var INITIALBULLETSPEED=2;
		var CURRENTBULLETSPEED=INITIALBULLETSPEED;
		var INITIALBULLETRANGE=250;
		var CURRENTBULLETRANGE=INITIALBULLETRANGE;
		var MAXBULLETSPEED=15;
		var MAXBULLETRANGE=500;
		var PIERCINGROUNDS = false;

		var WIDTH;
		var HEIGHT;
		var FOODCHANCE=4000;
		var ENEMYSPAWNTIMER=150;
		var CHASEDURATION=5;
		var LEVELINCREMENT=10;
		var LEVELCAP=8;
		var DAMP = 1.20;
		var damp =1;
		
		var score=-1;
		var scoreAdjusted = false;
		
		var rightDown = false;
		var leftDown = false;
		var upDown = false;
		var downDown = false;
		var spaceDown = false;
		
		// PLAYER OBJECT
		function Player()
		{
			this.levelDisplayTime=5;
			this.levelTimeActivated=0;
			this.size=30;
			this.x=WIDTH/2;
			this.y=HEIGHT/2;
			this.levelX=this.x;
			this.levelY=this.y;
			this.drawingLevel=false;
			this.currentLevelTime=0;
			this.currentLevel=0;
			this.dy=2;
			this.dx=2;
			this.radius = 10;
			this.visible = true;
			this.shooting = false;
			this.rateOfFire = 10;
			this.cooldown = 0;
			this.color = "yellow";
			this.invincible = false;
			this.isMoving = false;
			this.currentSpell = "null";
			this.dead = false;
			this.levelUp=function(x)
			{
				this.levelX=player.x;
				this.levelY=player.y;
				this.currentLevel=x;
				this.levelTimeActivated=time;
				this.drawingLevel=true;
				nova.cooldown-=(nova.COOLDOWN-2)/LEVELCAP;
				nova.range+=nova.MAXRANGE/LEVELCAP;
				nova.speed+=nova.MAXSPEED/LEVELCAP;
				bomb.cooldown-=(bomb.COOLDOWN-3)/LEVELCAP;
				bomb.duration-=(bomb.DURATION-.5)/LEVELCAP;
				bomb.MAXRADIUS+=(bomb.MAXRANGE)/LEVELCAP;
				blink.cooldown-=(blink.COOLDOWN-.5)/LEVELCAP;
				CURRENTBULLETRADIUS+=(MAXBULLETRADIUS-INITIALBULLETRADIUS)/LEVELCAP;	
				CURRENTBULLETSPEED+=(MAXBULLETSPEED-INITIALBULLETSPEED)/LEVELCAP;
				CURRENTBULLETRANGE+=(MAXBULLETRANGE-INITIALBULLETRANGE)/LEVELCAP;
				test=CURRENTBULLETSPEED;
			};
			this.drawLevel=function()
			{
				if(this.drawingLevel)
				{
					this.currentLevelTime=Math.floor(time-this.levelTimeActivated);
					if(this.currentLevelTime<this.levelDisplayTime)
					{
						ctx.fillStyle="red";
						ctx.font="bold 14px Arial";
						ctx.fillText("Level "+this.currentLevel+"!",this.levelX,this.levelY);
						this.levelY-=.5;
					}
					else
					{
						this.levelTimeActivated=0;
						this.drawingLevel=false;
						this.levelX=this.x;
						this.levelY=this.y;
					}
				}
			};
			this.reset=function()
			{
				this.currentLevel=0;
				this.x=WIDTH/2;
				this.y=HEIGHT/2;
			};
		}
		var player = new Player();
		
		// NOVA OBJECT
		// ADJUST SO COOLDOWN BEGINS AFTER COMPLETE
		function Nova()
		{
			this.MAXSPEED=2.5;
			this.COOLDOWN = 4.5;
			this.MAXRANGE = 120;
			this.RANGE = 60;
			this.SPEED = 1;
			this.speed = 1;
			this.strokeWidth=3;
			this.range = this.RANGE;
			this.visible = false;
			this.radius = player.radius;
			this.inProgress = false;
			this.cooldown = this.COOLDOWN;
			this.cooldownCount =0;
			this.timeActivated=0;
			this.reset=function()
			{
				this.cooldown=this.COOLDOWN;
				this.range=this.RANGE;	
				this.speed=this.SPEED;
			};
		}
		var nova = new Nova();
	
		// BLINK OBJECT
		function Blink()
		{
			this.COOLDOWN=10;
			this.onCooldown=false;
			this.timeActivated=0;
			this.cooldown = this.COOLDOWN;
			this.clicked = false;
			this.cooldownCount = 0;
			this.y = 0;
			this.y = 0;
			this.residueX=0;
			this.residueY=0;
			this.RESIDUERADIUS=player.radius*2;
			this.residueRadius=this.RESIDUERADIUS;
			this.ARRIVALRADIUS=player.radius;
			this.arrivalRadius=this.ARRIVALRADIUS;
			this.drawnArrival = false;
			this.drawnResidue = false;
			this.color="white";
			this.activated = function()
			{
				if(!this.onCooldown && player.currentSpell=="blink" && this.clicked)
				{
					return true;
				}
				else
					return false;
			};
			this.drawResidue=function()
			{
			// Draw circles shrinking from player radius*2 to radius 1
			if(!this.drawnResidue)
			{
				if(this.residueRadius>1)
				{
					ctx.strokeStyle=this.color;
					ctx.beginPath();
					ctx.arc(this.residueX,this.residueY,this.residueRadius,0,2*Math.PI,true);
					ctx.closePath();
					ctx.stroke();
					this.residueRadius--;
				}
				else
				{
					this.drawnResidue=true;
				}
			}
		};	
			this.drawArrival=function()
			{
			// Draw circles shrinking from player radius to player radius*2
			if(!blink.drawnArrival)
			{
				if(this.arrivalRadius<player.radius*2)
				{
					ctx.strokeStyle=this.color;
					ctx.beginPath();
					ctx.arc(this.x,this.y,this.arrivalRadius,0,2*Math.PI,true);
					ctx.closePath();
					ctx.stroke();
					this.arrivalRadius++;			
				}
				else
				{
					this.drawnArrival=true;
				}
			}	
		};
			this.reset=function()
			{
				this.onCooldown = false;
				this.drawnArrival = false;
				this.drawnResidue = false;
				this.residueRadius = this.RESIDUERADIUS;
				this.arrivalRadius = this.ARRIVALRADIUS;
				this.cooldownCount=0;
			};
		}
		var blink = new Blink();
		
		function Bomb()
		{
			this.MAXRANGE=450;
			this.COOLDOWN=10;
			this.DURATION=2;
			this.strokeWidth = 5;
			this.activated=false;
			this.cooldown=this.COOLDOWN;
			this.onCooldown=false;
			this.cooldownCount=0;
			this.color="red";
			this.x=0;
			this.y=0;
			this.timeActivated=0;
			this.clicked=false;
			this.radius=10;
			this.STARTMAXRADIUS=150;
			this.MAXRADIUS=this.STARTMAXRADIUS;
			this.exploded = false;
			this.duration=this.DURATION;
			this.currentTime=0;
			this.speed = 2;
			this.reset=function()
			{
				this.onCooldown=false;
				this.activated = false;
				this.exploded=false;
				this.cooldownCount=0;
				this.radius = 10;
				this.timeActivated=0;
				this.currentTime=0;
				this.color="red";
			};
			this.update=function()
			{
				this.currentTime=time-this.timeActivated;
				if(this.cooldownCount>0)
				{
					this.onCooldown=true;
					this.cooldownCount = this.cooldown - Math.floor(time-this.timeActivated);
				}
				else
				{
					this.reset();
				}
				if(!this.exploded && this.currentTime>=this.duration/4 && this.currentTime < this.duration/2)
				{
					this.color="red";
				}
				else if(!this.exploded && this.currentTime>=this.duration/2 && this.currentTime <(this.duration*3)/4)
				{
					this.color="white";
				}
				else if(!this.exploded && this.currentTime>=(this.duration*3)/4 && this.currentTime < this.duration)
				{
					this.color="red";
				}
				else if(!this.exploded && this.currentTime>this.duration)
				{
					this.color="white";
					this.exploded=true;
				}
				if(this.exploded)
				{
					this.color="yellow";
				}
			};
			this.drawBomb=function()
			{
				if(this.activated)
				{
					if(!this.exploded)
					{
						this.update();
						ctx.lineWidth=this.strokeWidth;
						ctx.fillStyle=this.color;
						ctx.beginPath();
						ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);
						ctx.closePath();
						ctx.fill();
					}
					else
					{
						if(this.radius < this.MAXRADIUS)
						{
							this.update();
							ctx.strokeStyle=this.color;
							ctx.beginPath();
							ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);
							ctx.closePath();
							ctx.stroke();
							ctx.beginPath();
							ctx.arc(this.x,this.y,Math.floor(this.radius/2),0,2*Math.PI);
							ctx.closePath();
							ctx.stroke();
							this.checkCollisions();
							this.radius+=this.speed;
						}
						else
						{
							// DONE
						}
					}
				}
			};
			this.checkCollisions=function()
			{
				for(var i=0;i<enemies.length;i++)
				{
					if(Math.sqrt(Math.pow(this.x-enemies[i].x,2)+Math.pow((this.y-enemies[i].y),2)) < this.radius
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-enemies[i].size,2)+Math.pow((this.y-enemies[i].y),2)) < this.radius
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-enemies[i].size,2)+Math.pow((this.y-enemies[i].y-enemies[i].size),2)) < this.radius
					|| Math.sqrt(Math.pow(this.x-enemies[i].x,2)+Math.pow((this.y-enemies[i].y-enemies[i].size),2)) < this.radius)
					{
						enemyResidues.push(new EnemyResidue(enemies[i].x,enemies[i].y,enemies[i].color,enemies[i].size));
						enemies.splice(i,1);
						updateScore();
					}
				}
			};
			this.init=function()
			{
				this.cooldown=this.COOLDOWN;
				this.duration=this.DURATION;
				this.MAXRADIUS=this.STARTMAXRADIUS;
			};
		}
		var bomb = new Bomb();
		// ENEMY RESIDUE EFFECT
		function EnemyResidue(x,y,color,enemySize)
		{
			this.strokeWidth=3;
			this.x=x;
			this.y=y;
			this.color=color;
			this.radius=1;
			this.MAXRADIUS=enemySize*1.5;
			this.drawn=false;
			this.interval=0;
			this.angle=Math.PI/8;
			this.strokeLength=.33;
			this.drawResidue=function()
			{
				if(this.radius<this.MAXRADIUS)
				{
					ctx.strokeStyle=this.color;
					ctx.lineWidth=this.strokeWidth;
					ctx.beginPath();
					ctx.arc(this.x,this.y,this.radius,this.interval,this.interval+this.strokeLength,false);
					ctx.closePath();
					ctx.stroke();
					this.radius+=.5;
					this.interval+=this.angle;
				}
				else
				{
					this.drawn = true;
					this.radius=0;
				}
			};		
		}
		// MOUSE STUFF
		var mouse = new Object();
		mouse.clickX =0;
		mouse.clickY =0;
		mouse.moveX =0;
		mouse.moveY =0;
		
		var enemySpawnTimer;
		var enemySpawnCount;
		var foodChance = FOODCHANCE;
		var chaseDuration = CHASEDURATION;
		
		var bullets = new Array();
		var enemies = new Array();
		var food = new Array();
		var enemyResidues = new Array();
		
		function Bullet(x,y,destX,destY)
		{
			this.strokeWidth=3;
			this.speed = CURRENTBULLETSPEED;
			this.range = CURRENTBULLETRANGE;
			this.initialX=x;
			this.initialY=y;
			this.x = x;
			this.y = y;
			this.visible = true;
			this.direction = "up";
			this.distance = 0;
			if(PIERCINGROUNDS)
				this.color = "red";
			else if(!PIERCINGROUNDS)
				this.color = "white";
			this.borderColor="grey";
			this.radius = CURRENTBULLETRADIUS;
			this.destinationX=destX;
			this.destinationY=destY;
			this.slope=(this.destinationX-this.x)/(this.destinationY-this.y);
			this.b = this.destinationY-this.slope*this.destinationX;
			this.getFinalDestination=function()
			{	
				finalX=0;
				finalY=0;
				finalX = -this.b/this.slope;
				this.destinationX=finalX;
				this.destinationY=finalY;
			};
			// this.getFinalDestination();
			this.dx=(this.destinationX-this.x)/this.range;
			this.dy=(this.destinationY-this.y)/this.range;
			this.checkCollision=function()
			{
				var hit = false;
				for(var i=0;i<enemies.length;i++)
				{
					if(
						// top left
					Math.sqrt(Math.pow(this.x-enemies[i].x,2)+Math.pow((this.y-enemies[i].y),2)) <= this.radius
						// top right
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-enemies[i].size,2)+Math.pow((this.y-enemies[i].y),2)) <= this.radius
						// bottom right
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-enemies[i].size,2)+Math.pow((this.y-enemies[i].y-enemies[i].size),2)) <= this.radius
						// bottom left
					|| Math.sqrt(Math.pow(this.x-enemies[i].x,2)+Math.pow((this.y-enemies[i].y-enemies[i].size),2)) <= this.radius
						// middle
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-(enemies[i].size/2),2)+Math.pow((this.y-enemies[i].y-(enemies[i].size/2)),2)) <= this.radius
						// top middle
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-(enemies[i].size/2),2)+Math.pow((this.y-enemies[i].y),2)) <= this.radius
						// left middle
					|| Math.sqrt(Math.pow(this.x-enemies[i].x,2)+Math.pow((this.y-enemies[i].y-(enemies[i].size/2)),2)) <= this.radius
						// right middle
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-enemies[i].size,2)+Math.pow((this.y-enemies[i].y-(enemies[i].size/2)),2)) <= this.radius
						// bottom middle
					|| Math.sqrt(Math.pow(this.x-enemies[i].x-(enemies[i].size/2),2)+Math.pow((this.y-enemies[i].y-enemies[i].size),2)) <= this.radius)
					{
						enemyResidues.push(new EnemyResidue(enemies[i].x,enemies[i].y,enemies[i].color,enemies[i].size));
						enemies.splice(i,1);
						updateScore();
						hit=true;
					}
				}
				return hit;
			};
			this.update=function()
			{
				// this.y-=this.speed;
				this.x+=this.dx*this.speed;
				this.y+=this.dy*this.speed;
				this.distance=Math.sqrt(Math.pow(this.x-this.initialX,2)+Math.pow(this.y-this.initialY,2));
				
			};
		}
		
		function PowerUp()
		{
			this.x=choose(WIDTH);
			this.y=choose(HEIGHT);
			this.size=20;
			this.color = "yellow";
			this.drawPowerUp=function()
			{
				ctx.strokeStyle=this.color;
				ctx.beginPath();
				ctx.rect(this.x,this.y,this.size,this.zie);
			};
		}
		var PowerUps = new Array();
		
		function Enemy()
		{
			this.size = 25;
			this.isChasing = true;
			this.chaseDirection=1;
			this.chaseDestinationX=0;
			this.chaseDestinationY=0;
			var choice = choose(5);
			if(choice==1)
			{
				this.color="green";
				this.chaseImage=green_ghost;
			}
			else if(choice==2)
			{
				this.color="red";
				this.chaseImage=red_ghost;
			}
			else if(choice==3)
			{
				this.color="orange";
				this.chaseImage=orange_ghost;
			}
			else if(choice==4)
			{
				this.color="teal";
				this.chaseImage=blue_ghost;
			}
			else
			{
				this.color="pink";
				this.chaseImage=pink_ghost;
			}
			this.fleeImage=flee_ghost;
			choice = choose(4);
			if(choice==1) // spawn top
			{
				this.x = choose(WIDTH)-this.size;
				this.y = 0;
			}
			else if(choice==2) // spawn left
			{
				this.x = 0;
				this.y = choose(HEIGHT)-this.size;
			}
			else if(choice==3) // spawn bottom
			{
				this.x = choose(WIDTH)-this.size;
				this.y = HEIGHT-this.size;
			}
			else if(choice==4) // spawn right
			{
				this.x = WIDTH-this.size;
				this.y = choose(HEIGHT)-this.size;
			}	
			this.chasePlayer=function()
			{
				this.isChasing=true;
				if(player.x < this.x)
				{
					this.x--;
				}
				else if(player.x > this.x)
				{
					this.x++;
				}
				else
				{
					this.x = this.x;
				}
			
				if(player.y < this.y)
				{
					this.y--;
				}
				else if(player.y > this.y)
				{
					this.y++;
				}
				else
				{
					this.y = this.y;
				}
			};
			this.runFromPlayer=function()
			{
				this.isChasing=false;
				player.invincible=true;
				if(time-chaseBeginTime>=CHASEDURATION)
				{
					this.isChasing=true;
				}
				if(time==chaseBeginTime)
				{
					this.chaseDirection = choose(4);
					if(this.chaseDirection==1) // run to top
					{
						this.chaseDestinationX = choose(WIDTH);
						this.chaseDestinationY = 0;
					}
					else if(this.chaseDirection==2) // run to bottom
					{
						this.chaseDestinationX = choose(WIDTH);
						this.chaseDestinationY = HEIGHT-this.size;
					}
					else if(this.chaseDirection==3) // run to left
					{
						this.chaseDestinationX = 0;
						this.chaseDestinationY = choose(HEIGHT);
					}
					else // run to right
					{
						this.chaseDestinationX = WIDTH-this.size;
						this.chaseDestinationY = choose(HEIGHT);
					}
				}
				if(this.chaseDestinationX < this.x)
				{
					this.x--;
				}
				else if(this.chaseDestinationX > this.x)
				{
					this.x++;
				}
				else
				{
					this.x = this.x;
				}
			
				if(this.chaseDestinationY < this.y)
				{
					this.y--;
				}
				else if(this.chaseDestinationY > this.y)
				{
					this.y++;
				}
				else
				{
					this.y = this.y;
				}
			};
			this.killZone=function()
			{
				var inRange = false;
				// Top left collision
				if(Math.sqrt(Math.pow(player.x-this.x,2)+Math.pow(player.y-this.y,2))<player.radius)
				{
					inRange = true;
				}
				// Top right collision
				if(Math.sqrt(Math.pow(player.x-this.x-this.size,2)+Math.pow(player.y-this.y,2))<player.radius)
				{
					inRange=true;
				}
				// Bottom left collision
				if(Math.sqrt(Math.pow(player.x-this.x,2)+Math.pow(player.y-this.y-this.size,2))<player.radius)
				{
					inRange=true;
				}
				// Bottom right collision
				if(Math.sqrt(Math.pow(player.x-this.x-this.size,2)+Math.pow(player.y-this.y-this.size,2))<player.radius)
				{
					inRange=true;
				}
				return inRange;
			};
		}
		
		function menuEnemy()
		{
			this.size = 25;
			var choice = choose(5);
			this.onScreen=true;
			if(choice==1)
			{
				this.color="green";
				this.chaseImage=green_ghost;
			}
			else if(choice==2)
			{
				this.color="red";
				this.chaseImage=red_ghost;
			}
			else if(choice==3)
			{
				this.color="orange";
				this.chaseImage=orange_ghost;
			}
			else if(choice==4)
			{
				this.color="blue";
				this.chaseImage=blue_ghost;
			}
			else
			{
				this.color="pink";
				this.chaseImage=pink_ghost;
			}
			choice = choose(4);
			if(choice==1) // spawn top
			{
				this.x = choose(WIDTH)-this.size;
				this.y = 0;
			}
			else if(choice==2) // spawn left
			{
				this.x = 0;
				this.y = choose(HEIGHT)-this.size;
			}
			else if(choice==3) // spawn bottom
			{
				this.x = choose(WIDTH)-this.size;
				this.y = HEIGHT-this.size;
			}
			else if(choice==4) // spawn right
			{
				this.x = WIDTH-this.size;
				this.y = choose(HEIGHT)-this.size;
			}
			this.startX=this.x;
			this.startY=this.y;
			this.endX;
			this.endY;
			if(this.startX==0) // left
			{
				this.endY=this.y;
				this.endX=WIDTH;
			}
			else if(this.startX==WIDTH-this.size) // right
			{
				this.endY=this.y;
				this.endX=0;
			}
			else if(this.startY==0) // top
			{
				this.endX=this.startX;
				this.endY=HEIGHT;
			}
			else if(this.startY==HEIGHT-this.size) // bottom
			{
				this.endX=this.startX;
				this.endY=0;
			}
			this.move=function()
			{
				this.isChasing=true;
				if(this.endX < this.x)
				{
					this.x--;
				}
				else if(this.endX > this.x)
				{
					this.x++;
				}
				else if(this.endY < this.y)
				{
					this.y--;
				}
				else if(this.endY > this.y)
				{
					this.y++;
				}
				else
				{
					this.onScreen=false;
				}
			};	
			this.draw=function()
			{
				ctx.drawImage(this.chaseImage,this.x,this.y,this.size,this.size);
			};	
		}
		
		function Food(x,y)
		{
			this.strokeWidth = 5;
			this.x=x;
			this.y=y;
			this.color="red";
			this.radius=10;
		}
		
		function choose(x)
		{
			return Math.floor((Math.random()*x)+1);		
		}
		
		function reset()
		{
			ms=0;
			time=0;
			player.dead=false;
			chaseBeginTime=0;
			nova.cooldownCount=0;
			nova.inProgress=false;
			nova.visible=false;
			nova.onCooldown=false;
			nova.timeActivated=0;
			blink.reset();
			blink.cooldown=blink.COOLDOWN;
			bomb.reset();
			bomb.init();
			player.reset();
			nova.reset();
			foodChance=FOODCHANCE;
			CURRENTBULLETRADIUS=INITIALBULLETRADIUS;
			CURRENTBULLETSPEED=INITIALBULLETSPEED;
			CURRENTBULLETRANGE=INITIALBULLETRANGE;
			score=0;	
			enemies=[];
			food=[];
			bullets=[];
			enemyResidues=[];
			player.currentSpell="null";
			
			init();
		}
		
		function init()
		{
			pink_ghost=document.getElementById("pink_ghost");
			orange_ghost=document.getElementById("orange_ghost");
			red_ghost=document.getElementById("red_ghost");
			blue_ghost=document.getElementById("blue_ghost");
			green_ghost=document.getElementById("green_ghost");
			flee_ghost=document.getElementById("pink_ghost");
			player_img=document.getElementById("player_img");
			
			foodChance=foodChance;
			enemySpawnTimer=ENEMYSPAWNTIMER;
			enemySpawnCount=0;
			clearInterval(thisInterval);
			interval = 10; //milliseconds
			ctx = document.getElementById('canvas').getContext('2d');
			canvas = document.getElementById('canvas');
			
			WIDTH = ctx.canvas.width;
			HEIGHT = ctx.canvas.height;
			
			window.addEventListener('keydown',onKeyDown,true);
			window.addEventListener('keyup',onKeyUp,true);
			canvas.addEventListener('mousedown',getMousePosition,false);
			canvas.addEventListener('mousemove',getMouseMovePosition,false);
			
			thisInterval = setInterval(draw,interval);
			
			player.x = WIDTH/2;
			player.y = HEIGHT/2;

			updateScore();
			
			food.push(new Food(50,50));	
		}
		
		function checkNovaCollision()
		{
			for(var i=0;i<enemies.length;i++)
			{
				if(Math.sqrt(Math.pow(nova.x-enemies[i].x,2)+Math.pow((nova.y-enemies[i].y),2)) < nova.radius
				|| Math.sqrt(Math.pow(nova.x-enemies[i].x-enemies[i].size,2)+Math.pow((nova.y-enemies[i].y),2)) < nova.radius
				|| Math.sqrt(Math.pow(nova.x-enemies[i].x-enemies[i].size,2)+Math.pow((nova.y-enemies[i].y-enemies[i].size),2)) < nova.radius
				|| Math.sqrt(Math.pow(nova.x-enemies[i].x,2)+Math.pow((nova.y-enemies[i].y-enemies[i].size),2)) < nova.radius)
				{
					enemyResidues.push(new EnemyResidue(enemies[i].x,enemies[i].y,enemies[i].color,enemies[i].size));
					enemies.splice(i,1);
					updateScore();
				}
			}
		}
				
		function updateScore()
		{
			score++;
			//score+=2;
			scoreAdjusted = true;
			foodChance-=2;
		}
		
		function drawScore()
		{
			ctx.fillStyle="white";
			ctx.font="bold 15px Arial";
			ctx.fillText("SCORE "+score,WIDTH/2-25,30);
		}
		
		function update()
		{
			ctx.strokeStyle="yellow";
			ctx.fillStyle="yellow";
			ms++;
			time=ms/100;
			
			if(chaseCountDown>0)
				chaseCountDown=CHASEDURATION-Math.floor(time-chaseBeginTime);
			else
			{
				chaseCountDown=0;
				player.invincible=false;
			}
				
			if(player.invincible && enemies.length==0)
			{
				player.invicible=false;
				enemies.push(new Enemy());
			}
			choice = choose(foodChance);
			if(choice==foodChance/2)
			{
				food.push(new Food(choose(WIDTH),choose(HEIGHT)));
			}
			enemySpawnCount++;
			if(enemySpawnCount>=enemySpawnTimer && !player.invincible)
			{
				enemies.push(new Enemy());
				enemySpawnCount=0;
			}
			drawEnemies();
			
			if(score > 5 && enemySpawnTimer > 10 && scoreAdjusted)
			{
				enemySpawnTimer-=Math.floor(score/10);
				scoreAdjusted=false;
			}
			
			if(player.invincible)
			{
				PIERCINGROUNDS=true;
			}
			else if(!player.invincible)
			{
				PIERCINGROUNDS=false;
			}
			drawScore();
			/*
			document.getElementById("spawnTimer").innerHTML="SpawnTimer ="+enemySpawnTimer;
			document.getElementById("foodChance").innerHTML="FoodChance="+foodChance;
			document.getElementById("novaCooldown").innerHTML="Nova Cooldown="+nova.cooldownCount;
			document.getElementById("chaseCountDown").innerHTML="Chase Countdown="+chaseCountDown;
			document.getElementById("blinkCooldown").innerHTML="Blink Cooldown="+blink.cooldownCount;
			document.getElementById("bombCooldown").innerHTML="Bomb Cooldown="+bomb.cooldownCount;
			document.getElementById("currentSpell").innerHTML="Current Spell="+player.currentSpell;
			document.getElementById("test").innerHTML="test = "+test;
			*/
		}	
		
		function doNova()
		{
			if(nova.cooldownCount>0)
				nova.cooldownCount=nova.cooldown-Math.floor(time-nova.timeActivated);
			else
				nova.cooldownCount=0;
			
			if(time - nova.timeActivated >= nova.cooldown)
			{
				nova.onCooldown = false;
			}
			if(nova.visible && nova.radius <= nova.range)
			{
				nova.radius+=nova.speed;
				ctx.strokeStyle="red";
				ctx.lineWidth = nova.strokeWidth;
				ctx.beginPath();
				ctx.arc(nova.x,nova.y,nova.radius,0,2*Math.PI,true);
				ctx.closePath();
				ctx.stroke();
				checkNovaCollision();
			}
			else if(nova.radius > nova.range)
			{
				nova.visible = false;
				nova.inProgress = false;
				nova.radius = player.radius;
			}
			
		}
		
		function doBomb()
		{
			bomb.update();
			bomb.drawBomb();
		}
		
		function doBlink()
		{
			if(blink.activated())
			{	
				blink.residueX=player.x;
				blink.residueY=player.y;
				player.x=blink.x;
				player.y=blink.y;
				blink.clicked=false;
				player.currentSpell="null";
				blink.onCooldown=true;
			}
			if(blink.cooldownCount > 0)
			{
				blink.cooldownCount = blink.cooldown-Math.floor(time-blink.timeActivated);
				blink.drawResidue();
				blink.drawArrival();
			}
			else
				blink.cooldownCount = 0;
			if(time-blink.timeActivated >= blink.cooldown)
			{
				blink.reset();
			}
		}
		
		function draw()
		{
			if(inMenu)
			{
				drawMenu();
			}
			else
			{
				// document.getElementById("time").innerHTML="Time="+time;
				clear();
				drawPlayer();
				update();
				drawFood();
				if(player.shooting)
				{
					player.cooldown++;
					player.cooldown=player.cooldown%player.rateOfFire;
					if(player.cooldown==0)
					{
						player.shooting=false;
					}
				}
				doNova();
				doBlink();
				doBomb();
				drawEnemyResidues();
				playerLevelUp();
				drawCooldowns();
				if(bullets.length!=0)
				{
					drawBullets();
				}
				else
				{
					bullets = [];
				}
			}	
		}
		
		function drawBullets()
		{
			
			for(var i=0;i<bullets.length;i++)
			{
				if(bullets[i].checkCollision() && !PIERCINGROUNDS)
				{
					bullets.splice(i,1);
				}
				if(bullets[i].distance<=bullets[i].range && bullets[i].visible)				
				{
					ctx.fillStyle=bullets[i].color;
					ctx.strokeStyle=bullets[i].borderColor;
					ctx.lineWidth=bullets[i].strokeWidth;
					ctx.beginPath();
					ctx.arc(bullets[i].x,bullets[i].y,bullets[i].radius,0,2*Math.PI);
					ctx.closePath();
					ctx.fill();
					ctx.stroke();
					bullets[i].update();
				}
				else
				{
					bullets[i].visible = false;
					bullets.splice(i,1);
				}	
			}
		}
		
		function clear()
		{
			ctx.clearRect(0,0,WIDTH,HEIGHT);
		}
		
		function drawPlayer()
		{
			playerMoving();	
			ctx.drawImage(player_img,player.x-player.size/2,player.y-player.size/2,player.size,player.size)
			player.drawLevel();
		}
		
		function drawEnemyResidues()
		{
			if(enemyResidues.length>0)
			{
				for(var i=0;i<enemyResidues.length;i++)
				{
					enemyResidues[i].drawResidue();
					if(enemyResidues[i].drawn)
					{
						enemyResidues.splice(i,1);
					}
				}	
			}
		}
		
		function playerMoving()
		{
			getFood();
			if( (upDown && leftDown) || (upDown && rightDown) ||
				(downDown && leftDown) || (downDown && rightDown))
			{
				damp = DAMP;
			}		
			if(upDown && player.y>=0)
			{
				player.y-=player.dy/damp;
				player.isMoving = true;	
			}
			if(downDown && player.y<=HEIGHT)
			{
				player.y+=player.dy/damp;
				player.isMoving = true;
			}
			if(leftDown && player.x>=0)
			{
				player.x-=player.dx/damp;
				player.isMoving= true;
			}
			if(rightDown && player.x<=WIDTH)
			{
				player.x+=player.dx/damp;
				player.isMoving = true;
			}
			else
				player.isMoving = false;
			damp=1;
		}

		function getFood()
		{
			var distance=0;
			for(var i=0;i<food.length;i++)
			{
				distance=Math.sqrt(Math.pow(player.x-food[i].x,2)+Math.pow(player.y-food[i].y,2));
				if(distance<=player.radius+food[i].radius)
				{
					food.splice(i,1);
					player.invincible=true;
					chaseBeginTime=time;
					chaseCountDown=CHASEDURATION;
					for(var j=0;j<enemies.length;j++)
					{
						enemies[j].runFromPlayer();
					}
				}
			}
		}
		
		function drawEnemies()
		{	
			var currentImage;
			for(var i=0;i<enemies.length;i++)
			{
				if(enemies[i].isChasing)
				{
					currentImage=enemies[i].chaseImage;
					enemies[i].chasePlayer();
				}
				else if(!enemies[i].isChasing)
				{
					enemies[i].runFromPlayer();
					currentImage=enemies[i].fleeImage;
				}
				ctx.drawImage(currentImage,enemies[i].x,enemies[i].y,enemies[i].size,enemies[i].size);
				ctx.closePath();
				if(enemies[i].isChasing)
				{
					if(enemies[i].killZone())
					{
						player.dead=true;
						gameOver();
					}
				}
				else if(!enemies[i].isChasing)
				{
					ctx.stroke();
				}
			}
		}
		
		function drawFood()
		{
			if(food.length!=0)
			{
				for(var i=0;i<food.length;i++)
				{
					ctx.strokeStyle=food[i].color;
					ctx.lineWidth=food[i].strokeWidth;
					ctx.beginPath();
					ctx.arc(food[i].x,food[i].y,food[i].radius,Math.PI/8,3*Math.PI/8,true);
					ctx.arc(food[i].x,food[i].y,food[i].radius,5*Math.PI/8,7*Math.PI/8,true);
					ctx.arc(food[i].x,food[i].y,food[i].radius,9*Math.PI/8,11*Math.PI/8,true);
					ctx.arc(food[i].x,food[i].y,food[i].radius,13*Math.PI/8,15*Math.PI/8,true);
					ctx.closePath();
					ctx.stroke();
				}
			}
		}
		
		function gameOver()
		{
			clearInterval(thisInterval);
			food=[];
			ctx.fillStyle="black";
			ctx.beginPath()
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			ctx.closePath();
			ctx.fill();
			ctx.fillStyle="white";
			ctx.font="bold 40px Arial";
			ctx.fillText("GAME OVER",WIDTH/2-125,HEIGHT/2);
			ctx.font="20px Arial";
			ctx.fillText("Press Enter to Play Again",WIDTH/2-115,HEIGHT/2+50);
		}
		
		function playerLevelUp()
		{
			thisLevel = Math.floor(score/LEVELINCREMENT);
			if(thisLevel==player.currentLevel)
			{
				return;
			}
			if(thisLevel==1)
			{
				player.levelUp(1);
			}
			else if(thisLevel==2)
			{
				player.levelUp(2);
			}
			else if(thisLevel==3)
			{
				player.levelUp(3);
			}
			else if(thisLevel==4)
			{
				player.levelUp(4);
			}
			else if(thisLevel==5)
			{
				player.levelUp(5);
			}
			else if(thisLevel==6)
			{
				player.levelUp(6);
			}
			else if(thisLevel==7)
			{
				player.levelUp(7);
			}
			else if(thisLevel==8)
			{
				player.levelUp(8);
			}
		}
		
		function drawCooldowns()
		{	
			margins=10;
			size=30;
			ctx.strokeStyle="#505050";
			ctx.fillStyle="green";
			//ctx.strokeStyle="grey";
			if(!nova.onCooldown)
			{
				ctx.fillStyle="green";
				ctx.beginPath();
				ctx.rect((WIDTH/2)-size-margins,HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 15px Arial";
				ctx.fillText("N",WIDTH/2-size-margins+(size/2)-5,HEIGHT-size/2-margins+5);
			}
			if(nova.onCooldown)
			{
				ctx.fillStyle="red";
				ctx.beginPath();
				ctx.rect((WIDTH/2)-size-margins,HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 12px Arial";
				ctx.fillText(Math.floor(nova.cooldownCount),WIDTH/2-size-margins+(size/2)-5,HEIGHT-size/2-margins+5);
			}
			if(!bomb.onCooldown)
			{
				ctx.fillStyle="green";
				ctx.beginPath();
				ctx.rect((WIDTH/2),HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 15px Arial";
				ctx.fillText("T",(WIDTH/2)+(size/2)-5,HEIGHT-size/2-margins+5);
			}
			if(bomb.onCooldown)
			{
				ctx.fillStyle="red";
				ctx.beginPath();
				ctx.rect((WIDTH/2),HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 15px Arial";
				ctx.fillText(Math.floor(bomb.cooldownCount),(WIDTH/2)+(size/2)-5,HEIGHT-size/2-margins+5);
			}
			if(!blink.onCooldown)
			{
				ctx.fillStyle="green";
				ctx.beginPath();
				ctx.rect((WIDTH/2+size+margins),HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 15px Arial";
				ctx.fillText("B",WIDTH/2+size+margins+(size/2)-5,HEIGHT-size/2-margins+5);
			}
			if(blink.onCooldown)
			{
				ctx.fillStyle="red";
				ctx.beginPath();
				ctx.rect((WIDTH/2+size+margins),HEIGHT-size-margins,size,size);
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
				ctx.fillStyle="white";
				ctx.font="bold 15px Arial";
				ctx.fillText(Math.floor(blink.cooldownCount),WIDTH/2+size+margins+(size/2)-5,HEIGHT-size/2-margins+5);
			}
		}
		
		// EVENT LISTENERS
		function onKeyDown(evt)
		{
			if(evt.keyCode==38 || evt.keyCode==87)
			{
				upDown = true;	
			}
			else if(evt.keyCode==40 || evt.keyCode==83)
			{
				downDown = true;
			}
			else if(evt.keyCode==37 || evt.keyCode==65)
			{
				leftDown = true;
			}
			else if(evt.keyCode==39 || evt.keyCode==68)
			{
				rightDown = true;
			}
			else if(evt.keyCode==32 && evt.shiftKey && !nova.onCooldown && !nova.inProgress)
			{
				spaceDown = true;
				nova.visible=true;
				nova.inProgress = true;
				nova.x = player.x;
				nova.y = player.y;
				nova.onCooldown = true;
				nova.timeActivated = time;
				nova.cooldownCount = nova.cooldown;
			}
			else if(evt.keyCode==32 && !nova.inProgress && !player.shooting && !evt.shiftKey)
			{

				thisBullet = new Bullet(player.x,player.y,mouse.moveX,mouse.moveY);
				bullets.push(thisBullet);
				player.shooting=true;
			}
			if(evt.keyCode==66 && !blink.onCooldown)
			{
				player.currentSpell="blink";
			}
			if(evt.keyCode==84 && !bomb.onCooldown)
			{
				player.currentSpell="bomb";
			}
			if(evt.keyCode==13 && player.dead || inMenu)
			{
				reset();
				inMenu=false;
				menuEnemies=[];
			}
		}
		function onKeyUp(evt)
		{
			if(evt.keyCode==38 || evt.keyCode == 87)
			{
				upDown = false;
			}
			else if(evt.keyCode==40 || evt.keyCode == 83)
			{
				downDown = false;
			}
			else if(evt.keyCode==37 || evt.keyCode==65)
			{
				leftDown = false;
			}
			else if(evt.keyCode==39 || evt.keyCode==68)
			{
				rightDown = false;
			}
			else if(evt.keyCode==32)
			{
				spaceDown = false;
			}
		}
		function getMousePosition(evt)
		{
			if(evt.x!=undefined && evt.y!=undefined)
			{
				mouse.clickX=evt.x-canvas.offsetLeft;
				mouse.clickY=evt.y-canvas.offsetTop;
			}
			else
			{
				mouse.clickX=evt.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-canvas.offsetLeft;
				mouse.clickY=evt.clientY+document.body.scrollTop+document.documentElement.scrollTop-canvas.offsetTop;
			}
			if(player.currentSpell=="blink")
			{
				blink.x=mouse.clickX;
				blink.y=mouse.clickY;
				blink.clicked=true;
				blink.timeActivated = time;
				blink.cooldownCount=blink.cooldown;
				player.currentSpell=="null";
			}
			if(player.currentSpell=="bomb")
			{
				bomb.x=mouse.clickX;
				bomb.y=mouse.clickY;
				bomb.clicked=true;
				bomb.activated=true;
				bomb.timeActivated=time;
				bomb.cooldownCount=bomb.cooldown;
				player.currentSpell="null";
			}
		}
		function getMouseMovePosition(evt)
		{
			if(evt.x!=undefined && evt.y!=undefined)
			{
				mouse.moveX=evt.clientX-canvas.offsetLeft;
				mouse.moveY=evt.clientY-canvas.offsetTop;
			}
			else
			{
				mouse.moveX=evt.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-canvas.offsetLeft;
				mouse.moveY=evt.clientY+document.body.scrollTop+document.documentElement.scrollTop-canvas.offsetTop;
			}
		}
		function drawMenu()
		{
			ms++;
			time=Math.floor(ms/100);
			ctx.fillStyle="black";
			ctx.beginPath();
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			ctx.closePath();
			ctx.fill();
			if((time==0  && time!=thisTime) || (time%2==0 && time!=thisTime))
			{
				menEn.push(new menuEnemy());
				thisTime=time;
			}
			for(var i=0;i<menEn.length;i++)
			{
				menEn[i].draw();
				menEn[i].move();
				if(!menEn[i].onScreen)
				{
					menEn.splice(i,1);
				}
			}
			menuX=0;
			menuY=50;
			ctx.fillStyle="black";
			ctx.rect(0,0,WIDTH,HEIGHT);
			ctx.fillStyle="white";
			ctx.font="bold 30px Arial";
			ctx.fillText("PRESS ENTER TO PLAY",WIDTH/2-160,HEIGHT/2);
			ctx.beginPath
			
		}
		function displayControls()
		{
			alert("CONTROLS:\n"+
					"A,S,D,W - Left, Back, Right, Forward\n"+
					"Space - Shoot in direction of mouse position\n"+
					"Shift+Space - Activate Nova spell\n"+
					"T + Click - Activate Timed Bomb at clicked area\n"+
					"B + Click - Activate Teleport to clicked area");
		}
		</script>
		
	</head>
	
	<body onload="init()">
		<h1><img id="title" src="pacman-title.png" alt="title" width="500" height="170"></h1>
		<canvas id="canvas" width="800" height="500">
		<img id="pink_ghost" src="pink_ghost.png" width="10" height="10">
		<img id="orange_ghost" src="orange_ghost.png" width="10" height="10">
		<img id="blue_ghost" src="blue_ghost.png" width="10" height="10">
		<img id="red_ghost" src="red_ghost.png" width="10" height="10">
		<img id="green_ghost" src="green_ghost.png" width="10" height="10">
		<img id="player_img" src="pacman.png" width="10" height="10">
		
		Your browser does not support the canvas element.
		</canvas>
		<!--
		<br>
			<button type="button" onclick="reset()">restart</button>
		</br>
		-->
		<div class="wrapper">
		<button type="button" onclick="displayControls()">Controls</button>
		</div>
		<!--
		<div id="spawnTimer">Spawn Timer = </div>
		<div id="foodChance">Food Chance= </div>
		<div id="time">Time =</div>
		<div id="novaCooldown">Nova Cooldown=</div>
		<div id="chaseCountDown">Chase Countdown =</div>
		<div id="blinkCooldown">Blink Cooldown =</div>
		<div id="bombCooldown">Bomb Cooldown = </div>
		<div id="currentSpell">Current Spell = </div>
		<div id="test">Test = </div>
		-->
	</body>
</html>